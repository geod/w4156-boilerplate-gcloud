{% extends "base.html" %}
{% block title %} Groups {% endblock %}
{% block body %}

<div class="container">
  {% if accepted|length > 0 %}
  <div class="section">
    <h5>Your Groups</h5>

    {% for group in accepted %}
      <div class="col s12">
        <div class="card blue-grey darken-1">
          <div class="card-content white-text">
            <span class="card-title">{{group}}</span>
            <p></p>
          </div>
          <div class="card-action">
            <a onclick="cur_group='{{group}}';newEditModal()" href="#modal2" class="modal-trigger">Add users</a>
            <a href="#">See recommendations</a>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  {% endif %}
  {% if pending|length > 0 %}
  <div class="divider"></div>
  <div class="section">
    <h5>Pending Groups</h5>

    {% for group in pending %}

      <div class="col s12">
        <div class="card blue-grey darken-1">
          <div class="card-content white-text">
            <span class="card-title">{{group}}</span>
            <p></p>
          </div>
          <div class="card-action">
            <a onclick="acceptGroup('{{group}}')" href="#">Accept</a>
            <a onclick="rejectGroup('{{group}}')" href="#">Reject</a>
            <!-- <a href="#">See recommendations</a> -->
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  {% endif %}

  {% if (pending|length == 0) and  (accepted|length == 0) %}
  <div class="section"><h5>You have no groups yet</h5></div>
  {% endif %}

  <div class="divider"></div>
  <div style="text-align:center" class="section">
    <a onclick="newgroup()" href="#modal1" title="create a new group" class="btn-floating btn-large waves-effect waves-light blue-grey modal-trigger"><i class="material-icons">add</i></a>
  </div>

  <div id="modal2" class="modal add">
    <div class="modal-content">
      <h4>Add users to group</h4>
      <br>
      <div class="row">
        <div class="input-field col s4">
          <input id="username_ed" type="text">
          <label for="username_ed">add by username</label>

        </div>
        <div class="col s4">
          <a onclick="add_user_edit_group()" title="add" class="btn-floating btn-large waves-effect waves-light blue-grey"><i class="material-icons">add</i></a>
        </div>
        <div style="color:red" id="edit_users_error" class="col s4"></div>
      </div>
      <div id="group_users_container_ed"></div>
    </div>

    <div class="modal-footer">
      <button onclick="addUsers()" href="#" class="waves-effect waves-green btn-flat">Add</a>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal1" class="modal create">
    <div class="modal-content">
      <h4>Create group</h4>
      <br>

      <div class="input-field col s6" style="width:50%">
        <input id="groupname_ng" type="text">
        <label for="groupname_ng">group name</label>
      </div>
      <div class="row">
        <div class="input-field col s4">
          <input id="username_ng" type="text">
          <label for="username_ng">add by username</label>
        </div>
        <div class="col s4">
          <a onclick="add_user_new_group()" title="add" class="btn-floating btn-large waves-effect waves-light blue-grey"><i class="material-icons">add</i></a>
        </div>
        <div style="color:red" id="modal_ng_error" class="col s4"></div>
      </div>
      <div id="group_users_container"></div>
      <div class="modal-footer">
        <button onclick="createGroup()" href="#" class="waves-effect waves-green btn-flat">Create</a>
      </div>

    </div>

  </div>

  <script type=text/javascript>
    $(document).ready(function(){
      $('.modal').modal();
    });

    var ng_usernames = []
    var add_usernames = []
    var cur_group = ''

    function add_user_new_group() {
      var input = document.getElementById('username_ng')
      var error = document.getElementById('modal_ng_error')
      var container = document.getElementById('group_users_container')
      if (!ng_usernames.includes(input.value) && input.value != '') {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.onreadystatechange = function() {
          if (this.readyState == 4) {
            if (this.status == 200) {
              ng_usernames.push(input.value)
              renderUsernames(container)
              input.value = ''
              error.innerHTML = ''
            } else {
              console.log('error user name bad')
              error.innerHTML = "sorry, we weren't able to add that username"
            }
          }
        };
        url = 'api/validate_username/' + input.value
        xmlHttp.open('GET', url, true)
        xmlHttp.setRequestHeader('Content-Type', 'text/plain')
        xmlHttp.send();
      }
    }

    function newgroup() {
      ng_usernames = []
      var container = document.getElementById('group_users_container')
      renderUsernames(container)
    }

    function newEditModal() {
      add_usernames = []
      var container = document.getElementById('group_users_container_ed')
      renderUsernames(container)
    }

    function renderUsernames(container) {
      var injected_html = ""
      for (var i = 0; i < ng_usernames.length; i++) {
        injected_html += "<div class='row'>" + ng_usernames[i] + "</div>"
      }
      container.innerHTML = injected_html
    }


    function addGroup() {
      var groupName = document.getElementById('groupname_ng')
      var xmlHttp = new XMLHttpRequest();
      var url = 'api/new_group/' + String(groupName.value) + '?'
      for (var i = 0; i < ng_usernames.length; i++) {
        url += ('&users=' + String(ng_usernames[i]))
        console.log(url)
      }
      console.log(url)
      xmlHttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
           window.location.href = '/groups'
        }
      };
      xmlHttp.open('PUT', url, true)
      xmlHttp.setRequestHeader('Content-Type', 'text/plain')
      xmlHttp.send();

    }

    function createGroup() {
      var groupName = document.getElementById('groupname_ng').value
      var error = document.getElementById('modal_ng_error')
      if (ng_usernames.length == 0) {
        error.innerHTML = "add some users to your group"
        return
      }
      var elem = document.querySelector('.modal.create')
      var modal = M.Modal.getInstance(elem)
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.onreadystatechange = function() {
        if (this.readyState == 4) {
          if (this.status == 200) {
            addGroup()
            error.innerHTML = ""
            modal.close()
          } else {
            console.log('error group name bad')
            error.innerHTML = "sorry, that group name is taken"
          }
        }
      };
      url = 'api/validate_groupname/' + groupName
      xmlHttp.open('GET', url, true)
      xmlHttp.setRequestHeader('Content-Type', 'text/plain')
      xmlHttp.send();
    }

    function acceptGroup(groupName) {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.onreadystatechange = function() {
        if (this.readyState == 4) {
          if (this.status == 200) {
            window.location.href = '/groups'
            console.log('done')
          }
        }
      };
      url = 'api/respond_to_request/' + groupName + '/' + 'accept'
      xmlHttp.open('PUT', url, true)
      xmlHttp.setRequestHeader('Content-Type', 'text/plain')
      xmlHttp.send();
    }

    function rejectGroup(groupName) {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.onreadystatechange = function() {
        if (this.readyState == 4) {
          if (this.status == 200) {
            window.location.href = '/groups'
            console.log('done')
          }
        }
      };
      url = 'api/respond_to_request/' + groupName + '/' + 'reject'
      xmlHttp.open('PUT', url, true)
      xmlHttp.setRequestHeader('Content-Type', 'text/plain')
      xmlHttp.send();
    }

    function add_user_edit_group() {
      var input = document.getElementById('username_ed')
      var error = document.getElementById('edit_users_error')
      var container = document.getElementById('group_users_container_ed')
      if (!add_usernames.includes(input.value) && input.value != '') {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.onreadystatechange = function() {
          if (this.readyState == 4) {
            if (this.status == 200) {
              add_usernames.push(input.value)
              var injected_html = ""
              for (var i = 0; i < add_usernames.length; i++) {
                injected_html += "<div class='row'>" + add_usernames[i] + "</div>"
              }
              container.innerHTML = injected_html
              input.value = ''
              error.innerHTML = ''
            } else {
              console.log('error user name bad')
              error.innerHTML = "sorry, we weren't able to add that username"
            }
          }
        };
        url = 'api/validate_username/existing/' + cur_group + '/' + input.value
        xmlHttp.open('GET', url, true)
        xmlHttp.setRequestHeader('Content-Type', 'text/plain')
        xmlHttp.send();
      }
    }

    function addUsers() {
      var error = document.getElementById('edit_users_error')
      if (add_usernames.length == 0) {
        error.innerHTML = "add some users to your group"
        return
      }
      var elem = document.querySelector('.modal.add')
      var modal = M.Modal.getInstance(elem)

      modal.close()
    }


  </script>

</div>


{% endblock %}
